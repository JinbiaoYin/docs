# 主键生成策略

在复杂分布式系统中，往往需要对大量的数据和消息进行唯一标识。如在美团点评的金融、支付、餐饮、酒店、猫眼电影等产品的系统中，数据日渐增长，对数据分库分表后需要有一个唯一 ID 来标识一条数据或消息，数据库的自增 ID 显然不能满足需求；特别一点的如订单、骑手、优惠券也都需要有唯一 ID 做标识。此时一个能够生成全局唯一 ID 的系统是非常必要的。


## UUID
标准型式包含32个16进制数字，形式为 8-4-4-4-12 的 36 个字符，示例：55038400-e29b-41d4-a716-446655440000。目前共有 5 种方式生成 UUID。

- 优点：
    - 性能高：本地生成，无网络消耗。
- 缺点：
    - 不易于存储: UUID 太长，通常以长度为36的字符串形式存储。
    - 信息不安全：基于 MAC 地址生成 UUID 的算法可能导致 MAC 地址泄露。

 > 注意：
 MySQL 官方明确建议主键越短越好，36 个字符长度的 UUID 不符合要求。
 对 MySQL 索引不利，作为数据库主键，在 InnoDB 引擎下，UUID 的无序性会引起数据位置频繁变动，严重影响性能。

##  SnowFlake(雪花算法) 
Twitter 公布的分布式主键生成算法。能够保证不同进程主键的不重复性，以及相同进程主键的有序性。同一个进程中，它首先通过时间位保证不重复，如果时间相同则通过序列位保证。同时由于时间是单调递增的，且各个服务器如果大体做了时间同步，那么生成的主键在分布式环境下可以认为是总体有序的，这就保证了对索引字段插入的高效性。例如 MySQL 的 InnoDB 储存引擎的主键。

使用雪花算法生成的主键，`二进制表示形式`包含 4 部分，从高位到低位分别为：1bit符号位，41bit时间戳位，10bit工作进程位，12bit序列号位。共 64 位。

- 符号位：1bit，预留，恒为 0 。
- 时间戳：41bit，可以容纳的毫秒数为 `2^41` 。一年的毫秒数为 `365*24*60*60*1000` ，41位的时间戳可以用`2^41/(365*24*60*60*1000)`约为 69.73 年。
- 工作进程位：10bit，工作进程的标识。能表示 2^10=1024 个进程，由于每个服务是单线程获取雪花ID的，所有最多只能有 1024 个服务。
- 序列号位：12bit，同一时间戳，工作进程中，1ms可以有 2^12 = 4096 个序列号。

## 美团 Leaf
沿用 snowflake 方案的 bit 位设计。对于 workerID 的分配，当服务集群数量较少的情况下，完全可以手动配置。Leaf 服务规模较大，动手配置成本太高。所以使用 Zookeeper 持久顺序节点的特性自动对 snowflake 节点配置 workerID。
